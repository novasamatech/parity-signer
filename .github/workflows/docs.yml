name:                         Check links and Publish Docs

on:
  pull_request:
  push:
    branches:
      - master

jobs:
  rustdocs_user_docs:
    name:                     Build rustdocs, user-docs and check links
    runs-on:                  ubuntu-latest
    steps:

      - name:                 Cancel Previous Runs
        uses:                 styfle/cancel-workflow-action@0.9.1
        with:
          access_token:       ${{ github.token }}

      - name:                 Checkout sources
        uses:                 actions/checkout@v3
        with:
          fetch-depth:        1
          submodules:         recursive

      # rustdocs
      # docs source dir ./rust/target/doc
      - name:                 Install rustdocs dependencies
        run:                  |
          sudo apt update
          sudo apt install -y clang libclang-dev libopencv-dev

      - name:                 Rust Cache
        uses:                 Swatinem/rust-cache@v1.3.0
        with:
          working-directory:  rust

      - name:                 Generate cargo doc
        run:                  |
          cd rust
          echo "Generating rustdocs to the user-docs dir so it's possible to check the links"
          cargo doc --all-features --verbose --target-dir ../docs/book/html/rustdocs/

      # user-docs
      # they are generated after rustdocs to check the relative links
      # docs source dir ./docs/book/html/
      - name:                 Setup mdBook
        uses:                 peaceiris/actions-mdbook@v1.1.14
        with:
          mdbook-version:     latest

      - name:                 Install mdbook-linkcheck
        uses:                 baptiste0928/cargo-install@v1
        with:
          crate:              mdbook-linkcheck

      - name:                 Install mdbook-mermaid
        uses:                 baptiste0928/cargo-install@v1
        with:
          crate:              mdbook-mermaid

      - name:                 Build user-docs
        run:                  |
          mdbook build docs

      # deploy
      - name:                 Cleanup before pushing
        # executed only on master so PRs can use cache
        if:                   ${{ github.ref == 'refs/heads/master' }}
        run:                  |
          echo "Removing everything but the docs dirs"
          shopt -s extglob
          rm -vrf !("./docs/book/html/")
          echo "Hosting user-docs from root and rustdocs from ./rustdocs/"
          mv ./docs/book/html/ ./

      - name:                 Deploy rustdocs and user-docs
        uses:                 peaceiris/actions-gh-pages@v3
        if:                   ${{ github.ref == 'refs/heads/master' }}
        with:
          github_token:       ${{ github.token }}
          force_orphan:       true
          publish_dir:        ./
